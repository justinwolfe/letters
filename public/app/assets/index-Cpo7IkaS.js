var we=Object.defineProperty;var be=(f,e,i)=>e in f?we(f,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):f[e]=i;var Z=(f,e,i)=>be(f,typeof e!="symbol"?e+"":e,i);import{j as s,M as pe}from"./markdown-vendor-FvuNcIv3.js";import{a as je,r as m,R as Se}from"./react-vendor-DJ1oPbzn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function i(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(a){if(a.ep)return;a.ep=!0;const r=i(a);fetch(a.href,r)}})();var z={},J=je;z.createRoot=J.createRoot,z.hydrateRoot=J.hydrateRoot;const ge="thankYouNotesDB",xe=1,p="emails",g="images",D="metadata";class ye{constructor(){Z(this,"db",null)}async init(){return new Promise((e,i)=>{const n=indexedDB.open(ge,xe);n.onerror=()=>i(n.error),n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=a=>{const r=a.target.result;if(!r.objectStoreNames.contains(p)){const o=r.createObjectStore(p,{keyPath:"id"});o.createIndex("publish_date","publish_date",{unique:!1}),o.createIndex("subject","subject",{unique:!1})}r.objectStoreNames.contains(g)||r.createObjectStore(g,{keyPath:"url"}),r.objectStoreNames.contains(D)||r.createObjectStore(D,{keyPath:"key"})}})}async saveEmail(e){if(!this.db)throw new Error("Database not initialized");return new Promise((i,n)=>{const o=this.db.transaction([p],"readwrite").objectStore(p).put(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}async saveEmails(e){if(!this.db)throw new Error("Database not initialized");return new Promise((i,n)=>{const a=this.db.transaction([p],"readwrite"),r=a.objectStore(p);e.forEach(o=>r.put(o)),a.oncomplete=()=>i(),a.onerror=()=>n(a.error)})}async getAllEmails(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,i)=>{const r=this.db.transaction([p],"readonly").objectStore(p).getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>i(r.error)})}async getEmail(e){if(!this.db)throw new Error("Database not initialized");return new Promise((i,n)=>{const o=this.db.transaction([p],"readonly").objectStore(p).get(e);o.onsuccess=()=>i(o.result||null),o.onerror=()=>n(o.error)})}async saveImage(e,i){if(!this.db)throw new Error("Database not initialized");return new Promise((n,a)=>{const l=this.db.transaction([g],"readwrite").objectStore(g).put({url:e,blob:i,savedAt:new Date().toISOString()});l.onsuccess=()=>n(),l.onerror=()=>a(l.error)})}async getImage(e){if(!this.db)throw new Error("Database not initialized");return new Promise((i,n)=>{const o=this.db.transaction([g],"readonly").objectStore(g).get(e);o.onsuccess=()=>{const l=o.result;i(l?l.blob:null)},o.onerror=()=>n(o.error)})}async setMetadata(e,i){if(!this.db)throw new Error("Database not initialized");return new Promise((n,a)=>{const l=this.db.transaction([D],"readwrite").objectStore(D).put({key:e,value:i,updatedAt:new Date().toISOString()});l.onsuccess=()=>n(),l.onerror=()=>a(l.error)})}async getMetadata(e){if(!this.db)throw new Error("Database not initialized");return new Promise((i,n)=>{const o=this.db.transaction([D],"readonly").objectStore(D).get(e);o.onsuccess=()=>{const l=o.result;i(l?l.value:null)},o.onerror=()=>n(o.error)})}async getStats(){if(!this.db)throw new Error("Database not initialized");const e=await this.getAllEmails(),i=await this.getMetadata("lastSync");return new Promise((n,a)=>{const l=this.db.transaction([g],"readonly").objectStore(g).getAll();l.onsuccess=()=>{const w=l.result,x=w.reduce((j,C)=>{var b;return j+(((b=C.blob)==null?void 0:b.size)||0)},0);n({emailCount:e.length,imageCount:w.length,totalSize:x,lastSync:i})},l.onerror=()=>a(l.error)})}async clearAll(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,i)=>{const n=this.db.transaction([p,g,D],"readwrite");n.objectStore(p).clear(),n.objectStore(g).clear(),n.objectStore(D).clear(),n.oncomplete=()=>e(),n.onerror=()=>i(n.error)})}async downloadAllContent(e){try{const i="/letters".startsWith("/letters")?"/letters":"",n=i==="/letters";e==null||e(0,100,"Fetching email list...");const a=n?`${i}/api/emails.json`:"/api/emails",r=await fetch(a);if(!r.ok)throw new Error("Failed to fetch emails");const o=await r.json();e==null||e(10,100,`Found ${o.length} emails`),await this.saveEmails(o),e==null||e(20,100,"Saved email list");const l=o.length;for(let w=0;w<l;w++){const x=o[w],j=20+Math.floor(w/l*60);e==null||e(j,100,`Downloading ${x.subject}...`);const C=n?`${i}/api/emails/${x.id}.json`:`/api/emails/${x.id}`,b=await fetch(C);if(b.ok){const $=await b.json();await this.saveEmail($)}}e==null||e(80,100,"Content downloaded"),e==null||e(85,100,"Downloading images..."),await this.downloadImages(o),await this.setMetadata("lastSync",new Date().toISOString()),e==null||e(100,100,"Download complete!")}catch(i){throw console.error("Download failed:",i),i}}async downloadImages(e){const i=new Set;e.forEach(a=>{if(a.image_url&&i.add(a.image_url),a.body){const r=/!\[.*?\]\((.*?)\)/g;let o;for(;(o=r.exec(a.body))!==null;)i.add(o[1])}});const n=Array.from(i);for(const a of n)try{const r=await fetch(a);if(r.ok){const o=await r.blob();await this.saveImage(a,o)}}catch(r){console.warn(`Failed to download image: ${a}`,r)}}}const O=new ye;function Ee(f){if(f===0)return"0 Bytes";const e=1024,i=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(f)/Math.log(e));return Math.round(f/Math.pow(e,n)*100)/100+" "+i[n]}const A="/letters",T=A.startsWith("/letters");function ve(){const f=localStorage.getItem("lastViewedLetter"),[e,i]=m.useState([]),[n,a]=m.useState([]),[r,o]=m.useState(null),[l,w]=m.useState(null),[x,j]=m.useState(!0),[C,b]=m.useState(null),[$,F]=m.useState(f?"reader":"list"),[y,q]=m.useState(""),[E,P]=m.useState("date-desc"),[ee,M]=m.useState(!1),[V,te]=m.useState(null),[U,W]=m.useState(null),[G,se]=m.useState(!1),[R,H]=m.useState(navigator.onLine),[Q,ae]=m.useState(!1),[I,k]=m.useState(null),[S,ne]=m.useState(null);m.useEffect(()=>{O.init().then(()=>{console.log("Offline storage initialized"),_()});const t=()=>{H(!0),K()},c=()=>H(!1);return window.addEventListener("online",t),window.addEventListener("offline",c),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",c)}},[]),m.useEffect(()=>{K()},[]),m.useEffect(()=>{const t=localStorage.getItem("lastViewedLetter");t&&!x&&!G&&(se(!0),N(t))},[x,G]),m.useEffect(()=>{if(y.trim())re(y);else{const t=v([...e],E);a(t)}},[y,E,e]);const K=async()=>{try{const t=T?`${A}/api/emails.json`:`${A}/api/emails`,c=await fetch(t);if(!c.ok)throw new Error("Failed to fetch emails");const d=await c.json();i(d),a(v(d,E)),j(!1)}catch(t){if(!R)try{const c=await O.getAllEmails();if(c.length>0){i(c),a(v(c,E)),j(!1);return}}catch(c){console.error("Failed to load cached emails:",c)}b(t instanceof Error?t.message:"An error occurred"),j(!1)}},re=async t=>{if(!t.trim()){a(v([...e],E)),M(!1);return}try{if(M(!0),T){const c=t.toLowerCase(),d=e.filter(h=>{var u;return h.subject.toLowerCase().includes(c)||((u=h.description)==null?void 0:u.toLowerCase().includes(c))});a(v(d,E))}else{const c=await fetch(`${A}/api/emails/search?q=${encodeURIComponent(t)}`);if(!c.ok)throw new Error("Failed to search emails");const d=await c.json();a(v(d,E))}M(!1)}catch(c){b(c instanceof Error?c.message:"An error occurred"),M(!1)}},v=(t,c)=>{const d=[...t];switch(c){case"date-desc":return d.sort((h,u)=>new Date(u.publish_date).getTime()-new Date(h.publish_date).getTime());case"date-asc":return d.sort((h,u)=>new Date(h.publish_date).getTime()-new Date(u.publish_date).getTime());case"subject-asc":return d.sort((h,u)=>h.subject.localeCompare(u.subject));case"subject-desc":return d.sort((h,u)=>u.subject.localeCompare(h.subject));default:return d}},oe=async()=>{try{if(T){if(e.length===0)return;const t=Math.floor(Math.random()*e.length);N(e[t].id)}else{const t=await fetch(`${A}/api/emails/random`);if(!t.ok)throw new Error("Failed to fetch random email");const c=await t.json();N(c.id)}}catch(t){b(t instanceof Error?t.message:"An error occurred")}},ie=async t=>{try{if(j(!0),T){const c=await fetch(`${A}/api/emails/${t}.json`);if(!c.ok)throw new Error("Failed to fetch email");const d=await c.json(),h=v([...e],"date-desc"),u=h.findIndex(B=>B.id===t),L={prev:u<h.length-1?h[u+1]:null,next:u>0?h[u-1]:null};o(d),w(L)}else{const[c,d]=await Promise.all([fetch(`${A}/api/emails/${t}`),fetch(`${A}/api/emails/${t}/navigation`)]);if(!c.ok)throw new Error("Failed to fetch email");if(!d.ok)throw new Error("Failed to fetch navigation");const h=await c.json(),u=await d.json();o(h),w(u)}F("reader"),j(!1),localStorage.setItem("lastViewedLetter",t)}catch(c){if(!R)try{const d=await O.getEmail(t);if(d){o(d);const h=await O.getAllEmails(),u=v(h,"date-desc"),L=u.findIndex(B=>B.id===t);w({prev:L<u.length-1?u[L+1]:null,next:L>0?u[L-1]:null}),F("reader"),j(!1);return}}catch(d){console.error("Failed to load cached email:",d)}b(c instanceof Error?c.message:"An error occurred"),j(!1)}},N=t=>{ie(t),window.scrollTo(0,0)},ce=()=>{F("list"),o(null),w(null)},X=t=>new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),le=t=>{const c=t.split(/<<MATCH>>|<<?\/MATCH>>/),d=[];for(let h=0;h<c.length;h++)h%2===0?d.push(c[h]):d.push(s.jsx("strong",{className:"search-highlight",children:c[h]},h));return s.jsx(s.Fragment,{children:d})},Y=50,de=t=>{W(null),te(t.targetTouches[0].clientX)},he=t=>{W(t.targetTouches[0].clientX)},ue=()=>{if(!V||!U)return;const t=V-U,c=t>Y,d=t<-Y;c&&(l!=null&&l.next)?N(l.next.id):d&&(l!=null&&l.prev)&&N(l.prev.id)},_=async()=>{try{const t=await O.getStats();ne(t)}catch(t){console.error("Failed to get offline stats:",t)}},me=async()=>{try{k({current:0,total:100,message:"Starting download..."}),await O.downloadAllContent((t,c,d)=>{k({current:t,total:c,message:d})}),await _(),setTimeout(()=>k(null),2e3)}catch{b("Failed to download content for offline use"),k(null)}},fe=async()=>{if(confirm("Are you sure you want to clear all offline data?"))try{await O.clearAll(),await _(),alert("Offline data cleared successfully")}catch{b("Failed to clear offline data")}};return x&&!r?s.jsx("div",{className:"container",children:s.jsx("div",{className:"loading",children:"Loading..."})}):C?s.jsx("div",{className:"container",children:s.jsxs("div",{className:"error",children:["Error: ",C]})}):s.jsxs("div",{className:"container",children:[!R&&s.jsxs("div",{className:"offline-banner",children:["📡 You're offline -"," ",S&&S.emailCount>0?`${S.emailCount} letters available`:"No offline content available"]}),I&&s.jsxs("div",{className:"download-progress",children:[s.jsx("div",{className:"download-progress-bar",children:s.jsx("div",{className:"download-progress-fill",style:{width:`${I.current}%`}})}),s.jsxs("p",{children:[I.message," (",I.current,"%)"]})]}),$==="list"?s.jsxs("div",{className:"email-list",children:[s.jsxs("header",{className:"header",children:[s.jsx("h1",{children:"thank you notes"}),s.jsx("p",{className:"subtitle",children:y?`${n.length} result${n.length!==1?"s":""}`:`${n.length} published issue${n.length!==1?"s":""}`})]}),s.jsxs("div",{className:"controls",children:[s.jsxs("div",{className:"search-container",children:[s.jsx("input",{type:"text",className:"search-input",placeholder:"Search newsletters...",value:y,onChange:t=>q(t.target.value)}),y&&s.jsx("button",{className:"clear-search",onClick:()=>q(""),title:"Clear search",children:"✕"})]}),s.jsxs("div",{className:"control-row",children:[s.jsxs("div",{className:"sort-container",children:[s.jsx("label",{htmlFor:"sort-select",children:"Sort by:"}),s.jsxs("select",{id:"sort-select",className:"sort-select",value:E,onChange:t=>P(t.target.value),children:[s.jsx("option",{value:"date-desc",children:"Newest First"}),s.jsx("option",{value:"date-asc",children:"Oldest First"}),s.jsx("option",{value:"subject-asc",children:"Subject (A-Z)"}),s.jsx("option",{value:"subject-desc",children:"Subject (Z-A)"})]})]}),y&&s.jsxs("div",{className:"result-count",children:[n.length," result",n.length!==1?"s":""]}),s.jsx("button",{className:"btn btn-random",onClick:oe,title:"Go to random letter",children:"🎲 Random Letter"}),s.jsx("button",{className:"btn btn-offline",onClick:()=>ae(!Q),title:"Offline settings",children:"📥 Offline"})]})]}),Q&&s.jsxs("div",{className:"offline-panel",children:[s.jsx("h3",{children:"Offline Mode"}),S?s.jsxs("div",{className:"offline-stats",children:[s.jsxs("p",{children:["📧 ",S.emailCount," letters saved"]}),s.jsxs("p",{children:["🖼️ ",S.imageCount," images cached"]}),s.jsxs("p",{children:["💾 ",Ee(S.totalSize)," total"]}),S.lastSync&&s.jsxs("p",{children:["🔄 Last sync:"," ",new Date(S.lastSync).toLocaleString()]})]}):s.jsx("p",{children:"No offline data available"}),s.jsxs("div",{className:"offline-actions",children:[s.jsx("button",{className:"btn btn-primary",onClick:me,disabled:!!I,children:I?"Downloading...":"⬇️ Download All Content"}),S&&S.emailCount>0&&s.jsx("button",{className:"btn btn-danger",onClick:fe,children:"🗑️ Clear Offline Data"})]}),s.jsx("p",{className:"offline-note",children:"Download all letters and images for offline reading. This app works as a Progressive Web App (PWA) - you can install it on your device for a native app experience."})]}),ee?s.jsx("div",{className:"searching",children:"Searching..."}):n.length===0?s.jsx("div",{className:"no-results",children:y?"No newsletters found matching your search.":"No newsletters available."}):s.jsx("div",{className:"list",children:n.map(t=>s.jsx("article",{className:"email-card",onClick:()=>N(t.id),children:s.jsxs("div",{className:"email-card-content",children:[s.jsx("h2",{children:t.subject}),t.searchSnippet?s.jsx("p",{className:"email-search-snippet",children:le(t.searchSnippet)}):t.description&&s.jsx("p",{className:"email-description",children:t.description}),s.jsx("time",{className:"email-date",children:X(t.publish_date)})]})},t.id))})]}):s.jsxs("div",{className:"email-reader",onTouchStart:de,onTouchMove:he,onTouchEnd:ue,children:[r&&s.jsxs("article",{className:"email-content",children:[s.jsxs("header",{className:"email-header",children:[s.jsx("h1",{children:r.subject}),s.jsx("time",{className:"email-date",children:X(r.publish_date)})]}),s.jsx("div",{className:"email-body",children:s.jsx(pe,{children:r.body||""})})]}),s.jsxs("nav",{className:"reader-nav reader-nav-bottom",children:[s.jsx("button",{onClick:ce,className:"btn-back-arrow",title:"Back to List",children:"home"}),s.jsxs("div",{className:"nav-buttons",children:[(l==null?void 0:l.prev)&&s.jsxs("button",{onClick:()=>N(l.prev.id),className:"btn btn-nav",children:["← ",l.prev.subject]}),(l==null?void 0:l.next)&&s.jsxs("button",{onClick:()=>N(l.next.id),className:"btn btn-nav",children:[l.next.subject," →"]})]})]})]})]})}z.createRoot(document.getElementById("root")).render(s.jsx(Se.StrictMode,{children:s.jsx(ve,{})}));
