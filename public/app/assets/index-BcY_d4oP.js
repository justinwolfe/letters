var Se=Object.defineProperty;var xe=(p,a,n)=>a in p?Se(p,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):p[a]=n;var ae=(p,a,n)=>xe(p,typeof a!="symbol"?a+"":a,n);import{j as t,M as ye}from"./markdown-vendor-FvuNcIv3.js";import{a as Ee,r as f,R as ve}from"./react-vendor-DJ1oPbzn.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&l(o)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function l(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();var V={},se=Ee;V.createRoot=se.createRoot,V.hydrateRoot=se.hydrateRoot;const Ne="thankYouNotesDB",Ce=1,g="emails",v="images",A="metadata";class De{constructor(){ae(this,"db",null)}async init(){return new Promise((a,n)=>{const l=indexedDB.open(Ne,Ce);l.onerror=()=>n(l.error),l.onsuccess=()=>{this.db=l.result,a()},l.onupgradeneeded=r=>{const s=r.target.result;if(!s.objectStoreNames.contains(g)){const o=s.createObjectStore(g,{keyPath:"id"});o.createIndex("publish_date","publish_date",{unique:!1}),o.createIndex("subject","subject",{unique:!1})}s.objectStoreNames.contains(v)||s.createObjectStore(v,{keyPath:"url"}),s.objectStoreNames.contains(A)||s.createObjectStore(A,{keyPath:"key"})}})}async saveEmail(a){if(!this.db)throw new Error("Database not initialized");return new Promise((n,l)=>{const o=this.db.transaction([g],"readwrite").objectStore(g).put(a);o.onsuccess=()=>n(),o.onerror=()=>l(o.error)})}async saveEmails(a){if(!this.db)throw new Error("Database not initialized");return new Promise((n,l)=>{const r=this.db.transaction([g],"readwrite"),s=r.objectStore(g);a.forEach(o=>s.put(o)),r.oncomplete=()=>n(),r.onerror=()=>l(r.error)})}async getAllEmails(){if(!this.db)throw new Error("Database not initialized");return new Promise((a,n)=>{const s=this.db.transaction([g],"readonly").objectStore(g).getAll();s.onsuccess=()=>a(s.result),s.onerror=()=>n(s.error)})}async getEmail(a){if(!this.db)throw new Error("Database not initialized");return new Promise((n,l)=>{const o=this.db.transaction([g],"readonly").objectStore(g).get(a);o.onsuccess=()=>n(o.result||null),o.onerror=()=>l(o.error)})}async saveImage(a,n){if(!this.db)throw new Error("Database not initialized");return new Promise((l,r)=>{const d=this.db.transaction([v],"readwrite").objectStore(v).put({url:a,blob:n,savedAt:new Date().toISOString()});d.onsuccess=()=>l(),d.onerror=()=>r(d.error)})}async getImage(a){if(!this.db)throw new Error("Database not initialized");return new Promise((n,l)=>{const o=this.db.transaction([v],"readonly").objectStore(v).get(a);o.onsuccess=()=>{const d=o.result;n(d?d.blob:null)},o.onerror=()=>l(o.error)})}async setMetadata(a,n){if(!this.db)throw new Error("Database not initialized");return new Promise((l,r)=>{const d=this.db.transaction([A],"readwrite").objectStore(A).put({key:a,value:n,updatedAt:new Date().toISOString()});d.onsuccess=()=>l(),d.onerror=()=>r(d.error)})}async getMetadata(a){if(!this.db)throw new Error("Database not initialized");return new Promise((n,l)=>{const o=this.db.transaction([A],"readonly").objectStore(A).get(a);o.onsuccess=()=>{const d=o.result;n(d?d.value:null)},o.onerror=()=>l(o.error)})}async getStats(){if(!this.db)throw new Error("Database not initialized");const a=await this.getAllEmails(),n=await this.getMetadata("lastSync");return new Promise((l,r)=>{const d=this.db.transaction([v],"readonly").objectStore(v).getAll();d.onsuccess=()=>{const w=d.result,b=w.reduce((u,x)=>{var j;return u+(((j=x.blob)==null?void 0:j.size)||0)},0);l({emailCount:a.length,imageCount:w.length,totalSize:b,lastSync:n})},d.onerror=()=>r(d.error)})}async clearAll(){if(!this.db)throw new Error("Database not initialized");return new Promise((a,n)=>{const l=this.db.transaction([g,v,A],"readwrite");l.objectStore(g).clear(),l.objectStore(v).clear(),l.objectStore(A).clear(),l.oncomplete=()=>a(),l.onerror=()=>n(l.error)})}async downloadAllContent(a){try{const n="/letters".startsWith("/letters")?"/letters":"",l=n==="/letters",r=await this.getMetadata("lastSync"),s=await this.getMetadata("emailCount");if(a==null||a(0,100,"Checking for updates..."),l&&!r)await this.bulkDownload(n,a);else{const d=l?`${n}/api/emails.json`:"/api/emails",w=await fetch(d);if(!w.ok)throw new Error("Failed to fetch email list");const b=await w.json(),u=b.length;if(u>s)a==null||a(5,100,`Found ${u-s} new emails`),await this.incrementalUpdate(b,s,n,l,a);else if(!r)await this.bulkDownload(n,a);else{a==null||a(10,100,"Already up to date, checking images...");const x=await this.getAllEmails();await this.downloadImages(x),a==null||a(100,100,"Already up to date!")}}await this.setMetadata("lastSync",new Date().toISOString());const o=(await this.getAllEmails()).length;await this.setMetadata("emailCount",o),a==null||a(100,100,"Download complete!")}catch(n){throw console.error("Download failed:",n),n}}async bulkDownload(a,n){n==null||n(10,100,"Downloading all content...");const l=`${a}/api/emails-full.json`,r=await fetch(l);if(!r.ok)throw new Error("Failed to fetch bulk email data");const o=(await r.json()).emails||[];n==null||n(30,100,`Processing ${o.length} emails...`),await this.saveEmails(o),n==null||n(70,100,"Content saved, downloading images..."),await this.downloadImages(o),n==null||n(95,100,"Images downloaded")}async incrementalUpdate(a,n,l,r,s){const o=await this.getAllEmails(),d=new Set(o.map(u=>u.id)),w=a.filter(u=>!d.has(u.id));if(w.length===0){s==null||s(100,100,"Already up to date!");return}s==null||s(10,100,`Downloading ${w.length} new emails...`);const b=w.length;for(let u=0;u<b;u++){const x=w[u],j=10+Math.floor(u/b*70);s==null||s(j,100,`Downloading ${x.subject}...`);const T=r?`${l}/api/emails/${x.id}.json`:`/api/emails/${x.id}`,I=await fetch(T);if(I.ok){const _=await I.json();await this.saveEmail(_)}}s==null||s(85,100,"Downloading new images..."),await this.downloadImages(w),s==null||s(95,100,"Update complete")}async downloadImages(a){const n=new Set;a.forEach(r=>{if(r.image_url&&n.add(r.image_url),r.body){const s=/!\[.*?\]\((.*?)\)/g;let o;for(;(o=s.exec(r.body))!==null;)n.add(o[1])}});const l=Array.from(n);for(const r of l)try{const s=await fetch(r);if(s.ok){const o=await s.blob();await this.saveImage(r,o)}}catch(s){console.warn(`Failed to download image: ${r}`,s)}}}const L=new De;function ke(p){if(p===0)return"0 Bytes";const a=1024,n=["Bytes","KB","MB","GB"],l=Math.floor(Math.log(p)/Math.log(a));return Math.round(p/Math.pow(a,l)*100)/100+" "+n[l]}const N="/letters",F=N.startsWith("/letters");function Ae(){const p=localStorage.getItem("lastViewedLetter"),[a,n]=f.useState([]),[l,r]=f.useState([]),[s,o]=f.useState(null),[d,w]=f.useState(null),[b,u]=f.useState(!0),[x,j]=f.useState(null),[T,I]=f.useState(p?"reader":"list"),[_,W]=f.useState(null),[C,G]=f.useState(""),[D,ne]=f.useState("date-desc"),[ie,M]=f.useState(!1),[H,re]=f.useState(null),[Q,K]=f.useState(null),[X,le]=f.useState(!1),[B,Y]=f.useState(navigator.onLine),[Z,oe]=f.useState(!1),[O,R]=f.useState(null),[S,ce]=f.useState(null);f.useEffect(()=>{L.init().then(()=>{console.log("Offline storage initialized"),q()});const e=()=>{Y(!0),J()},i=()=>Y(!1),c=h=>{const E=new URLSearchParams(window.location.search).get("letter");if(E&&a.length>0){const $=a.find(te=>te.slug===E||te.id===E);$&&P($.id)}else U()};return window.addEventListener("online",e),window.addEventListener("offline",i),window.addEventListener("popstate",c),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",i),window.removeEventListener("popstate",c)}},[a]),f.useEffect(()=>{J()},[]),f.useEffect(()=>{const e=localStorage.getItem("lastViewedLetter");e&&!b&&!X&&(le(!0),y(e))},[b,X]),f.useEffect(()=>{if(b||a.length===0)return;const i=new URLSearchParams(window.location.search).get("letter");if(i){const c=a.find(h=>h.slug===i?!0:(h.slug||h.id)===i);if(c){localStorage.setItem("pwa-preferred","true"),y(c.id);const h=window.location.pathname;window.history.replaceState({},"",h)}}},[b,a]),f.useEffect(()=>{if(C.trim())de(C);else{const e=k([...a],D);r(e)}},[C,D,a]);const J=async()=>{try{const e=F?`${N}/api/emails.json`:`${N}/api/emails`,i=await fetch(e);if(!i.ok)throw new Error("Failed to fetch emails");const c=await i.json();n(c),r(k(c,D)),u(!1)}catch(e){if(!B)try{const i=await L.getAllEmails();if(i.length>0){n(i),r(k(i,D)),u(!1);return}}catch(i){console.error("Failed to load cached emails:",i)}j(e instanceof Error?e.message:"An error occurred"),u(!1)}},de=async e=>{if(!e.trim()){r(k([...a],D)),M(!1);return}try{if(M(!0),F){const i=e.toLowerCase(),c=a.filter(h=>{var m;return h.subject.toLowerCase().includes(i)||((m=h.description)==null?void 0:m.toLowerCase().includes(i))});r(k(c,D))}else{const i=await fetch(`${N}/api/emails/search?q=${encodeURIComponent(e)}`);if(!i.ok)throw new Error("Failed to search emails");const c=await i.json();r(k(c,D))}M(!1)}catch(i){j(i instanceof Error?i.message:"An error occurred"),M(!1)}},k=(e,i)=>{const c=[...e];switch(i){case"date-desc":return c.sort((h,m)=>new Date(m.publish_date).getTime()-new Date(h.publish_date).getTime());case"date-asc":return c.sort((h,m)=>new Date(h.publish_date).getTime()-new Date(m.publish_date).getTime());case"subject-asc":return c.sort((h,m)=>h.subject.localeCompare(m.subject));case"subject-desc":return c.sort((h,m)=>m.subject.localeCompare(h.subject));default:return c}},he=async()=>{try{if(F){if(a.length===0)return;const e=Math.floor(Math.random()*a.length);y(a[e].id)}else{const e=await fetch(`${N}/api/emails/random`);if(!e.ok)throw new Error("Failed to fetch random email");const i=await e.json();y(i.id)}}catch(e){j(e instanceof Error?e.message:"An error occurred")}},P=async e=>{try{if(u(!0),F){const i=await fetch(`${N}/api/emails/${e}.json`);if(!i.ok)throw new Error("Failed to fetch email");const c=await i.json(),h=k([...a],"date-desc"),m=h.findIndex($=>$.id===e),E={prev:m<h.length-1?h[m+1]:null,next:m>0?h[m-1]:null};o(c),w(E)}else{const[i,c]=await Promise.all([fetch(`${N}/api/emails/${e}`),fetch(`${N}/api/emails/${e}/navigation`)]);if(!i.ok)throw new Error("Failed to fetch email");if(!c.ok)throw new Error("Failed to fetch navigation");const h=await i.json(),m=await c.json();o(h),w(m)}I("reader"),u(!1),localStorage.setItem("lastViewedLetter",e)}catch(i){if(!B)try{const c=await L.getEmail(e);if(c){o(c);const h=await L.getAllEmails(),m=k(h,"date-desc"),E=m.findIndex($=>$.id===e);w({prev:E<m.length-1?m[E+1]:null,next:E>0?m[E-1]:null}),I("reader"),u(!1);return}}catch(c){console.error("Failed to load cached email:",c)}j(i instanceof Error?i.message:"An error occurred"),u(!1)}},y=e=>{P(e),window.scrollTo(0,0);const i=a.find(c=>c.id===e);if(i){const c=i.slug||e,h=`${window.location.pathname}?letter=${encodeURIComponent(c)}`;window.history.pushState({letterId:e},"",h)}},U=()=>{I("list"),o(null),w(null),W(null);const e=window.location.pathname;window.history.pushState({},"",e)},ue=async e=>{try{u(!0),W(e);const i=await fetch(`${N}/api/tags/${encodeURIComponent(e)}/emails`);if(!i.ok)throw new Error("Failed to fetch emails by tag");const c=await i.json();r(c),I("tag"),u(!1),window.scrollTo(0,0)}catch(i){j(i instanceof Error?i.message:"An error occurred"),u(!1)}},z=e=>new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),me=e=>{const i=e.split(/<<MATCH>>|<<?\/MATCH>>/),c=[];for(let h=0;h<i.length;h++)h%2===0?c.push(i[h]):c.push(t.jsx("strong",{className:"search-highlight",children:i[h]},h));return t.jsx(t.Fragment,{children:c})},ee=50,fe=e=>{K(null),re(e.targetTouches[0].clientX)},we=e=>{K(e.targetTouches[0].clientX)},pe=()=>{if(!H||!Q)return;const e=H-Q,i=e>ee,c=e<-ee;i&&(d!=null&&d.next)?y(d.next.id):c&&(d!=null&&d.prev)&&y(d.prev.id)},q=async()=>{try{const e=await L.getStats();ce(e)}catch(e){console.error("Failed to get offline stats:",e)}},be=async()=>{try{R({current:0,total:100,message:"Starting download..."}),await L.downloadAllContent((e,i,c)=>{R({current:e,total:i,message:c})}),await q(),setTimeout(()=>R(null),2e3)}catch{j("Failed to download content for offline use"),R(null)}},je=async()=>{if(confirm("Are you sure you want to clear all offline data?"))try{await L.clearAll(),await q(),alert("Offline data cleared successfully")}catch{j("Failed to clear offline data")}},ge=async()=>{if(!s)return;const e=s.slug||s.id,i=`${window.location.origin}/letters/letters/${e}.html?pwa=1`;if(navigator.share)try{await navigator.share({title:s.subject,text:s.description||s.subject,url:i})}catch(c){c instanceof Error&&c.name!=="AbortError"&&console.error("Share failed:",c)}else try{await navigator.clipboard.writeText(i),alert("Link copied to clipboard!")}catch(c){console.error("Failed to copy:",c),alert(`Copy this link: ${i}`)}};return b&&!s?t.jsx("div",{className:"container",children:t.jsx("div",{className:"loading",children:"Loading..."})}):x?t.jsx("div",{className:"container",children:t.jsxs("div",{className:"error",children:["Error: ",x]})}):t.jsxs("div",{className:"container",children:[!B&&t.jsxs("div",{className:"offline-banner",children:["ðŸ“¡ You're offline -"," ",S&&S.emailCount>0?`${S.emailCount} letters available`:"No offline content available"]}),O&&t.jsxs("div",{className:"download-progress",children:[t.jsx("div",{className:"download-progress-bar",children:t.jsx("div",{className:"download-progress-fill",style:{width:`${O.current}%`}})}),t.jsxs("p",{children:[O.message," (",O.current,"%)"]})]}),T==="list"?t.jsxs("div",{className:"email-list",children:[t.jsxs("header",{className:"header",children:[t.jsx("h1",{children:"thank you notes"}),t.jsx("p",{className:"subtitle",children:C?`${l.length} result${l.length!==1?"s":""}`:`${l.length} published issue${l.length!==1?"s":""}`})]}),t.jsxs("div",{className:"controls",children:[t.jsxs("div",{className:"search-container",children:[t.jsx("input",{type:"text",className:"search-input",placeholder:"Search newsletters...",value:C,onChange:e=>G(e.target.value)}),C&&t.jsx("button",{className:"clear-search",onClick:()=>G(""),title:"Clear search",children:"âœ•"})]}),t.jsxs("div",{className:"control-row",children:[t.jsxs("div",{className:"sort-container",children:[t.jsx("label",{htmlFor:"sort-select",children:"Sort by:"}),t.jsxs("select",{id:"sort-select",className:"sort-select",value:D,onChange:e=>ne(e.target.value),children:[t.jsx("option",{value:"date-desc",children:"Newest First"}),t.jsx("option",{value:"date-asc",children:"Oldest First"}),t.jsx("option",{value:"subject-asc",children:"Subject (A-Z)"}),t.jsx("option",{value:"subject-desc",children:"Subject (Z-A)"})]})]}),C&&t.jsxs("div",{className:"result-count",children:[l.length," result",l.length!==1?"s":""]}),t.jsx("button",{className:"btn btn-random",onClick:he,title:"Go to random letter",children:"ðŸŽ² Random Letter"}),t.jsx("button",{className:"btn btn-offline",onClick:()=>oe(!Z),title:"Offline settings",children:"ðŸ“¥ Offline"})]})]}),Z&&t.jsxs("div",{className:"offline-panel",children:[t.jsx("h3",{children:"Offline Mode"}),S?t.jsxs("div",{className:"offline-stats",children:[t.jsxs("p",{children:["ðŸ“§ ",S.emailCount," letters saved"]}),t.jsxs("p",{children:["ðŸ–¼ï¸ ",S.imageCount," images cached"]}),t.jsxs("p",{children:["ðŸ’¾ ",ke(S.totalSize)," total"]}),S.lastSync&&t.jsxs("p",{children:["ðŸ”„ Last sync:"," ",new Date(S.lastSync).toLocaleString()]})]}):t.jsx("p",{children:"No offline data available"}),t.jsxs("div",{className:"offline-actions",children:[t.jsx("button",{className:"btn btn-primary",onClick:be,disabled:!!O,children:O?"Downloading...":"â¬‡ï¸ Download All Content"}),S&&S.emailCount>0&&t.jsx("button",{className:"btn btn-danger",onClick:je,children:"ðŸ—‘ï¸ Clear Offline Data"})]}),t.jsx("p",{className:"offline-note",children:"Download all letters and images for offline reading. This app works as a Progressive Web App (PWA) - you can install it on your device for a native app experience."})]}),ie?t.jsx("div",{className:"searching",children:"Searching..."}):l.length===0?t.jsx("div",{className:"no-results",children:C?"No newsletters found matching your search.":"No newsletters available."}):t.jsx("div",{className:"list",children:l.map(e=>t.jsx("article",{className:"email-card",onClick:()=>y(e.id),children:t.jsxs("div",{className:"email-card-content",children:[t.jsx("h2",{children:e.subject}),e.searchSnippet?t.jsx("p",{className:"email-search-snippet",children:me(e.searchSnippet)}):e.description&&t.jsx("p",{className:"email-description",children:e.description}),t.jsx("time",{className:"email-date",children:z(e.publish_date)})]})},e.id))})]}):T==="tag"?t.jsxs("div",{className:"email-list",children:[t.jsxs("header",{className:"header",children:[t.jsx("h1",{children:t.jsx("button",{onClick:U,className:"back-link",children:"â† back"})}),t.jsxs("h2",{className:"tag-title",children:["#",_]}),t.jsxs("p",{className:"subtitle",children:[l.length," letter",l.length!==1?"s":""," with this tag"]})]}),t.jsx("div",{className:"list",children:l.map(e=>t.jsx("article",{className:"email-card",onClick:()=>y(e.id),children:t.jsxs("div",{className:"email-card-content",children:[t.jsx("h2",{children:e.subject}),e.description&&t.jsx("p",{className:"email-description",children:e.description}),t.jsx("time",{className:"email-date",children:z(e.publish_date)})]})},e.id))})]}):t.jsxs("div",{className:"email-reader",onTouchStart:fe,onTouchMove:we,onTouchEnd:pe,children:[s&&t.jsxs("article",{className:"email-content",children:[t.jsxs("header",{className:"email-header",children:[t.jsx("h1",{children:s.subject}),t.jsxs("div",{className:"email-header-meta",children:[t.jsx("time",{className:"email-date",children:z(s.publish_date)}),t.jsx("button",{onClick:ge,className:"btn-share",title:"Share this letter","aria-label":"Share this letter",children:"â†— Share"})]})]}),t.jsx("div",{className:"email-body",children:t.jsx(ye,{children:s.body||""})}),s.tags&&s.tags.length>0&&t.jsxs("footer",{className:"email-tags",children:[t.jsx("div",{className:"tags-label",children:"Tags:"}),t.jsx("div",{className:"tags-list",children:s.tags.map(e=>t.jsxs("button",{className:"tag-badge",onClick:()=>ue(e.normalized_name),title:`View all letters tagged with "${e.name}"`,children:["#",e.name]},e.id))})]})]}),t.jsxs("nav",{className:"reader-nav reader-nav-bottom",children:[t.jsx("button",{onClick:U,className:"btn-back-arrow",title:"Back to List",children:"home"}),t.jsxs("div",{className:"nav-buttons",children:[(d==null?void 0:d.prev)&&t.jsxs("button",{onClick:()=>y(d.prev.id),className:"btn btn-nav",children:["â† ",d.prev.subject]}),(d==null?void 0:d.next)&&t.jsxs("button",{onClick:()=>y(d.next.id),className:"btn btn-nav",children:[d.next.subject," â†’"]})]})]})]})]})}V.createRoot(document.getElementById("root")).render(t.jsx(ve.StrictMode,{children:t.jsx(Ae,{})}));
