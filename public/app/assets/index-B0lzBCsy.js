var we=Object.defineProperty;var pe=(p,e,n)=>e in p?we(p,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):p[e]=n;var Z=(p,e,n)=>pe(p,typeof e!="symbol"?e+"":e,n);import{j as a,M as be}from"./markdown-vendor-FvuNcIv3.js";import{a as je,r as f,R as Se}from"./react-vendor-DJ1oPbzn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();var z={},J=je;z.createRoot=J.createRoot,z.hydrateRoot=J.hydrateRoot;const xe="thankYouNotesDB",ye=1,b="emails",v="images",A="metadata";class Ee{constructor(){Z(this,"db",null)}async init(){return new Promise((e,n)=>{const o=indexedDB.open(xe,ye);o.onerror=()=>n(o.error),o.onsuccess=()=>{this.db=o.result,e()},o.onupgradeneeded=i=>{const s=i.target.result;if(!s.objectStoreNames.contains(b)){const r=s.createObjectStore(b,{keyPath:"id"});r.createIndex("publish_date","publish_date",{unique:!1}),r.createIndex("subject","subject",{unique:!1})}s.objectStoreNames.contains(v)||s.createObjectStore(v,{keyPath:"url"}),s.objectStoreNames.contains(A)||s.createObjectStore(A,{keyPath:"key"})}})}async saveEmail(e){if(!this.db)throw new Error("Database not initialized");return new Promise((n,o)=>{const r=this.db.transaction([b],"readwrite").objectStore(b).put(e);r.onsuccess=()=>n(),r.onerror=()=>o(r.error)})}async saveEmails(e){if(!this.db)throw new Error("Database not initialized");return new Promise((n,o)=>{const i=this.db.transaction([b],"readwrite"),s=i.objectStore(b);e.forEach(r=>s.put(r)),i.oncomplete=()=>n(),i.onerror=()=>o(i.error)})}async getAllEmails(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,n)=>{const s=this.db.transaction([b],"readonly").objectStore(b).getAll();s.onsuccess=()=>e(s.result),s.onerror=()=>n(s.error)})}async getEmail(e){if(!this.db)throw new Error("Database not initialized");return new Promise((n,o)=>{const r=this.db.transaction([b],"readonly").objectStore(b).get(e);r.onsuccess=()=>n(r.result||null),r.onerror=()=>o(r.error)})}async saveImage(e,n){if(!this.db)throw new Error("Database not initialized");return new Promise((o,i)=>{const c=this.db.transaction([v],"readwrite").objectStore(v).put({url:e,blob:n,savedAt:new Date().toISOString()});c.onsuccess=()=>o(),c.onerror=()=>i(c.error)})}async getImage(e){if(!this.db)throw new Error("Database not initialized");return new Promise((n,o)=>{const r=this.db.transaction([v],"readonly").objectStore(v).get(e);r.onsuccess=()=>{const c=r.result;n(c?c.blob:null)},r.onerror=()=>o(r.error)})}async setMetadata(e,n){if(!this.db)throw new Error("Database not initialized");return new Promise((o,i)=>{const c=this.db.transaction([A],"readwrite").objectStore(A).put({key:e,value:n,updatedAt:new Date().toISOString()});c.onsuccess=()=>o(),c.onerror=()=>i(c.error)})}async getMetadata(e){if(!this.db)throw new Error("Database not initialized");return new Promise((n,o)=>{const r=this.db.transaction([A],"readonly").objectStore(A).get(e);r.onsuccess=()=>{const c=r.result;n(c?c.value:null)},r.onerror=()=>o(r.error)})}async getStats(){if(!this.db)throw new Error("Database not initialized");const e=await this.getAllEmails(),n=await this.getMetadata("lastSync");return new Promise((o,i)=>{const c=this.db.transaction([v],"readonly").objectStore(v).getAll();c.onsuccess=()=>{const w=c.result,j=w.reduce((m,y)=>{var S;return m+(((S=y.blob)==null?void 0:S.size)||0)},0);o({emailCount:e.length,imageCount:w.length,totalSize:j,lastSync:n})},c.onerror=()=>i(c.error)})}async clearAll(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,n)=>{const o=this.db.transaction([b,v,A],"readwrite");o.objectStore(b).clear(),o.objectStore(v).clear(),o.objectStore(A).clear(),o.oncomplete=()=>e(),o.onerror=()=>n(o.error)})}async downloadAllContent(e){try{const n="/letters".startsWith("/letters")?"/letters":"",o=n==="/letters",i=await this.getMetadata("lastSync"),s=await this.getMetadata("emailCount");if(e==null||e(0,100,"Checking for updates..."),o&&!i)await this.bulkDownload(n,e);else{const c=o?`${n}/api/emails.json`:"/api/emails",w=await fetch(c);if(!w.ok)throw new Error("Failed to fetch email list");const j=await w.json(),m=j.length;if(m>s)e==null||e(5,100,`Found ${m-s} new emails`),await this.incrementalUpdate(j,s,n,o,e);else if(!i)await this.bulkDownload(n,e);else{e==null||e(10,100,"Already up to date, checking images...");const y=await this.getAllEmails();await this.downloadImages(y),e==null||e(100,100,"Already up to date!")}}await this.setMetadata("lastSync",new Date().toISOString());const r=(await this.getAllEmails()).length;await this.setMetadata("emailCount",r),e==null||e(100,100,"Download complete!")}catch(n){throw console.error("Download failed:",n),n}}async bulkDownload(e,n){n==null||n(10,100,"Downloading all content...");const o=`${e}/api/emails-full.json`,i=await fetch(o);if(!i.ok)throw new Error("Failed to fetch bulk email data");const r=(await i.json()).emails||[];n==null||n(30,100,`Processing ${r.length} emails...`),await this.saveEmails(r),n==null||n(70,100,"Content saved, downloading images..."),await this.downloadImages(r),n==null||n(95,100,"Images downloaded")}async incrementalUpdate(e,n,o,i,s){const r=await this.getAllEmails(),c=new Set(r.map(m=>m.id)),w=e.filter(m=>!c.has(m.id));if(w.length===0){s==null||s(100,100,"Already up to date!");return}s==null||s(10,100,`Downloading ${w.length} new emails...`);const j=w.length;for(let m=0;m<j;m++){const y=w[m],S=10+Math.floor(m/j*70);s==null||s(S,100,`Downloading ${y.subject}...`);const F=i?`${o}/api/emails/${y.id}.json`:`/api/emails/${y.id}`,O=await fetch(F);if(O.ok){const E=await O.json();await this.saveEmail(E)}}s==null||s(85,100,"Downloading new images..."),await this.downloadImages(w),s==null||s(95,100,"Update complete")}async downloadImages(e){const n=new Set;e.forEach(i=>{if(i.image_url&&n.add(i.image_url),i.body){const s=/!\[.*?\]\((.*?)\)/g;let r;for(;(r=s.exec(i.body))!==null;)n.add(r[1])}});const o=Array.from(n);for(const i of o)try{const s=await fetch(i);if(s.ok){const r=await s.blob();await this.saveImage(i,r)}}catch(s){console.warn(`Failed to download image: ${i}`,s)}}}const k=new Ee;function ve(p){if(p===0)return"0 Bytes";const e=1024,n=["Bytes","KB","MB","GB"],o=Math.floor(Math.log(p)/Math.log(e));return Math.round(p/Math.pow(e,o)*100)/100+" "+n[o]}const C="/letters",T=C.startsWith("/letters");function ge(){const p=localStorage.getItem("lastViewedLetter"),[e,n]=f.useState([]),[o,i]=f.useState([]),[s,r]=f.useState(null),[c,w]=f.useState(null),[j,m]=f.useState(!0),[y,S]=f.useState(null),[F,O]=f.useState(p?"reader":"list"),[E,q]=f.useState(""),[g,P]=f.useState("date-desc"),[ee,M]=f.useState(!1),[U,te]=f.useState(null),[V,W]=f.useState(null),[G,ae]=f.useState(!1),[R,H]=f.useState(navigator.onLine),[Q,se]=f.useState(!1),[I,$]=f.useState(null),[x,ne]=f.useState(null);f.useEffect(()=>{k.init().then(()=>{console.log("Offline storage initialized"),_()});const t=()=>{H(!0),K()},l=()=>H(!1);return window.addEventListener("online",t),window.addEventListener("offline",l),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",l)}},[]),f.useEffect(()=>{K()},[]),f.useEffect(()=>{const t=localStorage.getItem("lastViewedLetter");t&&!j&&!G&&(ae(!0),D(t))},[j,G]),f.useEffect(()=>{if(E.trim())ie(E);else{const t=N([...e],g);i(t)}},[E,g,e]);const K=async()=>{try{const t=T?`${C}/api/emails.json`:`${C}/api/emails`,l=await fetch(t);if(!l.ok)throw new Error("Failed to fetch emails");const d=await l.json();n(d),i(N(d,g)),m(!1)}catch(t){if(!R)try{const l=await k.getAllEmails();if(l.length>0){n(l),i(N(l,g)),m(!1);return}}catch(l){console.error("Failed to load cached emails:",l)}S(t instanceof Error?t.message:"An error occurred"),m(!1)}},ie=async t=>{if(!t.trim()){i(N([...e],g)),M(!1);return}try{if(M(!0),T){const l=t.toLowerCase(),d=e.filter(h=>{var u;return h.subject.toLowerCase().includes(l)||((u=h.description)==null?void 0:u.toLowerCase().includes(l))});i(N(d,g))}else{const l=await fetch(`${C}/api/emails/search?q=${encodeURIComponent(t)}`);if(!l.ok)throw new Error("Failed to search emails");const d=await l.json();i(N(d,g))}M(!1)}catch(l){S(l instanceof Error?l.message:"An error occurred"),M(!1)}},N=(t,l)=>{const d=[...t];switch(l){case"date-desc":return d.sort((h,u)=>new Date(u.publish_date).getTime()-new Date(h.publish_date).getTime());case"date-asc":return d.sort((h,u)=>new Date(h.publish_date).getTime()-new Date(u.publish_date).getTime());case"subject-asc":return d.sort((h,u)=>h.subject.localeCompare(u.subject));case"subject-desc":return d.sort((h,u)=>u.subject.localeCompare(h.subject));default:return d}},oe=async()=>{try{if(T){if(e.length===0)return;const t=Math.floor(Math.random()*e.length);D(e[t].id)}else{const t=await fetch(`${C}/api/emails/random`);if(!t.ok)throw new Error("Failed to fetch random email");const l=await t.json();D(l.id)}}catch(t){S(t instanceof Error?t.message:"An error occurred")}},re=async t=>{try{if(m(!0),T){const l=await fetch(`${C}/api/emails/${t}.json`);if(!l.ok)throw new Error("Failed to fetch email");const d=await l.json(),h=N([...e],"date-desc"),u=h.findIndex(B=>B.id===t),L={prev:u<h.length-1?h[u+1]:null,next:u>0?h[u-1]:null};r(d),w(L)}else{const[l,d]=await Promise.all([fetch(`${C}/api/emails/${t}`),fetch(`${C}/api/emails/${t}/navigation`)]);if(!l.ok)throw new Error("Failed to fetch email");if(!d.ok)throw new Error("Failed to fetch navigation");const h=await l.json(),u=await d.json();r(h),w(u)}O("reader"),m(!1),localStorage.setItem("lastViewedLetter",t)}catch(l){if(!R)try{const d=await k.getEmail(t);if(d){r(d);const h=await k.getAllEmails(),u=N(h,"date-desc"),L=u.findIndex(B=>B.id===t);w({prev:L<u.length-1?u[L+1]:null,next:L>0?u[L-1]:null}),O("reader"),m(!1);return}}catch(d){console.error("Failed to load cached email:",d)}S(l instanceof Error?l.message:"An error occurred"),m(!1)}},D=t=>{re(t),window.scrollTo(0,0)},le=()=>{O("list"),r(null),w(null)},X=t=>new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),ce=t=>{const l=t.split(/<<MATCH>>|<<?\/MATCH>>/),d=[];for(let h=0;h<l.length;h++)h%2===0?d.push(l[h]):d.push(a.jsx("strong",{className:"search-highlight",children:l[h]},h));return a.jsx(a.Fragment,{children:d})},Y=50,de=t=>{W(null),te(t.targetTouches[0].clientX)},he=t=>{W(t.targetTouches[0].clientX)},ue=()=>{if(!U||!V)return;const t=U-V,l=t>Y,d=t<-Y;l&&(c!=null&&c.next)?D(c.next.id):d&&(c!=null&&c.prev)&&D(c.prev.id)},_=async()=>{try{const t=await k.getStats();ne(t)}catch(t){console.error("Failed to get offline stats:",t)}},me=async()=>{try{$({current:0,total:100,message:"Starting download..."}),await k.downloadAllContent((t,l,d)=>{$({current:t,total:l,message:d})}),await _(),setTimeout(()=>$(null),2e3)}catch{S("Failed to download content for offline use"),$(null)}},fe=async()=>{if(confirm("Are you sure you want to clear all offline data?"))try{await k.clearAll(),await _(),alert("Offline data cleared successfully")}catch{S("Failed to clear offline data")}};return j&&!s?a.jsx("div",{className:"container",children:a.jsx("div",{className:"loading",children:"Loading..."})}):y?a.jsx("div",{className:"container",children:a.jsxs("div",{className:"error",children:["Error: ",y]})}):a.jsxs("div",{className:"container",children:[!R&&a.jsxs("div",{className:"offline-banner",children:["ðŸ“¡ You're offline -"," ",x&&x.emailCount>0?`${x.emailCount} letters available`:"No offline content available"]}),I&&a.jsxs("div",{className:"download-progress",children:[a.jsx("div",{className:"download-progress-bar",children:a.jsx("div",{className:"download-progress-fill",style:{width:`${I.current}%`}})}),a.jsxs("p",{children:[I.message," (",I.current,"%)"]})]}),F==="list"?a.jsxs("div",{className:"email-list",children:[a.jsxs("header",{className:"header",children:[a.jsx("h1",{children:"thank you notes"}),a.jsx("p",{className:"subtitle",children:E?`${o.length} result${o.length!==1?"s":""}`:`${o.length} published issue${o.length!==1?"s":""}`})]}),a.jsxs("div",{className:"controls",children:[a.jsxs("div",{className:"search-container",children:[a.jsx("input",{type:"text",className:"search-input",placeholder:"Search newsletters...",value:E,onChange:t=>q(t.target.value)}),E&&a.jsx("button",{className:"clear-search",onClick:()=>q(""),title:"Clear search",children:"âœ•"})]}),a.jsxs("div",{className:"control-row",children:[a.jsxs("div",{className:"sort-container",children:[a.jsx("label",{htmlFor:"sort-select",children:"Sort by:"}),a.jsxs("select",{id:"sort-select",className:"sort-select",value:g,onChange:t=>P(t.target.value),children:[a.jsx("option",{value:"date-desc",children:"Newest First"}),a.jsx("option",{value:"date-asc",children:"Oldest First"}),a.jsx("option",{value:"subject-asc",children:"Subject (A-Z)"}),a.jsx("option",{value:"subject-desc",children:"Subject (Z-A)"})]})]}),E&&a.jsxs("div",{className:"result-count",children:[o.length," result",o.length!==1?"s":""]}),a.jsx("button",{className:"btn btn-random",onClick:oe,title:"Go to random letter",children:"ðŸŽ² Random Letter"}),a.jsx("button",{className:"btn btn-offline",onClick:()=>se(!Q),title:"Offline settings",children:"ðŸ“¥ Offline"})]})]}),Q&&a.jsxs("div",{className:"offline-panel",children:[a.jsx("h3",{children:"Offline Mode"}),x?a.jsxs("div",{className:"offline-stats",children:[a.jsxs("p",{children:["ðŸ“§ ",x.emailCount," letters saved"]}),a.jsxs("p",{children:["ðŸ–¼ï¸ ",x.imageCount," images cached"]}),a.jsxs("p",{children:["ðŸ’¾ ",ve(x.totalSize)," total"]}),x.lastSync&&a.jsxs("p",{children:["ðŸ”„ Last sync:"," ",new Date(x.lastSync).toLocaleString()]})]}):a.jsx("p",{children:"No offline data available"}),a.jsxs("div",{className:"offline-actions",children:[a.jsx("button",{className:"btn btn-primary",onClick:me,disabled:!!I,children:I?"Downloading...":"â¬‡ï¸ Download All Content"}),x&&x.emailCount>0&&a.jsx("button",{className:"btn btn-danger",onClick:fe,children:"ðŸ—‘ï¸ Clear Offline Data"})]}),a.jsx("p",{className:"offline-note",children:"Download all letters and images for offline reading. This app works as a Progressive Web App (PWA) - you can install it on your device for a native app experience."})]}),ee?a.jsx("div",{className:"searching",children:"Searching..."}):o.length===0?a.jsx("div",{className:"no-results",children:E?"No newsletters found matching your search.":"No newsletters available."}):a.jsx("div",{className:"list",children:o.map(t=>a.jsx("article",{className:"email-card",onClick:()=>D(t.id),children:a.jsxs("div",{className:"email-card-content",children:[a.jsx("h2",{children:t.subject}),t.searchSnippet?a.jsx("p",{className:"email-search-snippet",children:ce(t.searchSnippet)}):t.description&&a.jsx("p",{className:"email-description",children:t.description}),a.jsx("time",{className:"email-date",children:X(t.publish_date)})]})},t.id))})]}):a.jsxs("div",{className:"email-reader",onTouchStart:de,onTouchMove:he,onTouchEnd:ue,children:[s&&a.jsxs("article",{className:"email-content",children:[a.jsxs("header",{className:"email-header",children:[a.jsx("h1",{children:s.subject}),a.jsx("time",{className:"email-date",children:X(s.publish_date)})]}),a.jsx("div",{className:"email-body",children:a.jsx(be,{children:s.body||""})})]}),a.jsxs("nav",{className:"reader-nav reader-nav-bottom",children:[a.jsx("button",{onClick:le,className:"btn-back-arrow",title:"Back to List",children:"home"}),a.jsxs("div",{className:"nav-buttons",children:[(c==null?void 0:c.prev)&&a.jsxs("button",{onClick:()=>D(c.prev.id),className:"btn btn-nav",children:["â† ",c.prev.subject]}),(c==null?void 0:c.next)&&a.jsxs("button",{onClick:()=>D(c.next.id),className:"btn btn-nav",children:[c.next.subject," â†’"]})]})]})]})]})}z.createRoot(document.getElementById("root")).render(a.jsx(Se.StrictMode,{children:a.jsx(ge,{})}));
