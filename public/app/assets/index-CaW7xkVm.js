var fe=Object.defineProperty;var we=(f,t,o)=>t in f?fe(f,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):f[t]=o;var W=(f,t,o)=>we(f,typeof t!="symbol"?t+"":t,o);import{j as e,M as be}from"./markdown-vendor-FvuNcIv3.js";import{a as pe,r as h,R as je}from"./react-vendor-DJ1oPbzn.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();var $={},X=pe;$.createRoot=X.createRoot,$.hydrateRoot=X.hydrateRoot;const Se="thankYouNotesDB",ge=1,w="emails",p="images",y="metadata";class xe{constructor(){W(this,"db",null)}async init(){return new Promise((t,o)=>{const a=indexedDB.open(Se,ge);a.onerror=()=>o(a.error),a.onsuccess=()=>{this.db=a.result,t()},a.onupgradeneeded=n=>{const r=n.target.result;if(!r.objectStoreNames.contains(w)){const i=r.createObjectStore(w,{keyPath:"id"});i.createIndex("publish_date","publish_date",{unique:!1}),i.createIndex("subject","subject",{unique:!1})}r.objectStoreNames.contains(p)||r.createObjectStore(p,{keyPath:"url"}),r.objectStoreNames.contains(y)||r.createObjectStore(y,{keyPath:"key"})}})}async saveEmail(t){if(!this.db)throw new Error("Database not initialized");return new Promise((o,a)=>{const i=this.db.transaction([w],"readwrite").objectStore(w).put(t);i.onsuccess=()=>o(),i.onerror=()=>a(i.error)})}async saveEmails(t){if(!this.db)throw new Error("Database not initialized");return new Promise((o,a)=>{const n=this.db.transaction([w],"readwrite"),r=n.objectStore(w);t.forEach(i=>r.put(i)),n.oncomplete=()=>o(),n.onerror=()=>a(n.error)})}async getAllEmails(){if(!this.db)throw new Error("Database not initialized");return new Promise((t,o)=>{const r=this.db.transaction([w],"readonly").objectStore(w).getAll();r.onsuccess=()=>t(r.result),r.onerror=()=>o(r.error)})}async getEmail(t){if(!this.db)throw new Error("Database not initialized");return new Promise((o,a)=>{const i=this.db.transaction([w],"readonly").objectStore(w).get(t);i.onsuccess=()=>o(i.result||null),i.onerror=()=>a(i.error)})}async saveImage(t,o){if(!this.db)throw new Error("Database not initialized");return new Promise((a,n)=>{const c=this.db.transaction([p],"readwrite").objectStore(p).put({url:t,blob:o,savedAt:new Date().toISOString()});c.onsuccess=()=>a(),c.onerror=()=>n(c.error)})}async getImage(t){if(!this.db)throw new Error("Database not initialized");return new Promise((o,a)=>{const i=this.db.transaction([p],"readonly").objectStore(p).get(t);i.onsuccess=()=>{const c=i.result;o(c?c.blob:null)},i.onerror=()=>a(i.error)})}async setMetadata(t,o){if(!this.db)throw new Error("Database not initialized");return new Promise((a,n)=>{const c=this.db.transaction([y],"readwrite").objectStore(y).put({key:t,value:o,updatedAt:new Date().toISOString()});c.onsuccess=()=>a(),c.onerror=()=>n(c.error)})}async getMetadata(t){if(!this.db)throw new Error("Database not initialized");return new Promise((o,a)=>{const i=this.db.transaction([y],"readonly").objectStore(y).get(t);i.onsuccess=()=>{const c=i.result;o(c?c.value:null)},i.onerror=()=>a(i.error)})}async getStats(){if(!this.db)throw new Error("Database not initialized");const t=await this.getAllEmails(),o=await this.getMetadata("lastSync");return new Promise((a,n)=>{const c=this.db.transaction([p],"readonly").objectStore(p).getAll();c.onsuccess=()=>{const j=c.result,E=j.reduce((S,L)=>{var g;return S+(((g=L.blob)==null?void 0:g.size)||0)},0);a({emailCount:t.length,imageCount:j.length,totalSize:E,lastSync:o})},c.onerror=()=>n(c.error)})}async clearAll(){if(!this.db)throw new Error("Database not initialized");return new Promise((t,o)=>{const a=this.db.transaction([w,p,y],"readwrite");a.objectStore(w).clear(),a.objectStore(p).clear(),a.objectStore(y).clear(),a.oncomplete=()=>t(),a.onerror=()=>o(a.error)})}async downloadAllContent(t){try{t==null||t(0,100,"Fetching email list...");const o=await fetch("/api/emails");if(!o.ok)throw new Error("Failed to fetch emails");const a=await o.json();t==null||t(10,100,`Found ${a.length} emails`),await this.saveEmails(a),t==null||t(20,100,"Saved email list");const n=a.length;for(let r=0;r<n;r++){const i=a[r],c=20+Math.floor(r/n*60);t==null||t(c,100,`Downloading ${i.subject}...`);const j=await fetch(`/api/emails/${i.id}`);if(j.ok){const E=await j.json();await this.saveEmail(E)}}t==null||t(80,100,"Content downloaded"),t==null||t(85,100,"Downloading images..."),await this.downloadImages(a),await this.setMetadata("lastSync",new Date().toISOString()),t==null||t(100,100,"Download complete!")}catch(o){throw console.error("Download failed:",o),o}}async downloadImages(t){const o=new Set;t.forEach(n=>{if(n.image_url&&o.add(n.image_url),n.body){const r=/!\[.*?\]\((.*?)\)/g;let i;for(;(i=r.exec(n.body))!==null;)o.add(i[1])}});const a=Array.from(o);for(const n of a)try{const r=await fetch(n);if(r.ok){const i=await r.blob();await this.saveImage(n,i)}}catch(r){console.warn(`Failed to download image: ${n}`,r)}}}const D=new xe;function ye(f){if(f===0)return"0 Bytes";const t=1024,o=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(f)/Math.log(t));return Math.round(f/Math.pow(t,a)*100)/100+" "+o[a]}const C="";function Ee(){const f=localStorage.getItem("lastViewedLetter"),[t,o]=h.useState([]),[a,n]=h.useState([]),[r,i]=h.useState(null),[c,j]=h.useState(null),[E,S]=h.useState(!0),[L,g]=h.useState(null),[Y,T]=h.useState(f?"reader":"list"),[x,B]=h.useState(""),[v,Z]=h.useState("date-desc"),[J,I]=h.useState(!1),[_,P]=h.useState(null),[z,q]=h.useState(null),[V,ee]=h.useState(!1),[F,G]=h.useState(navigator.onLine),[H,te]=h.useState(!1),[A,k]=h.useState(null),[b,se]=h.useState(null);h.useEffect(()=>{D.init().then(()=>{console.log("Offline storage initialized"),R()});const s=()=>{G(!0),U()},l=()=>G(!1);return window.addEventListener("online",s),window.addEventListener("offline",l),()=>{window.removeEventListener("online",s),window.removeEventListener("offline",l)}},[]),h.useEffect(()=>{U()},[]),h.useEffect(()=>{const s=localStorage.getItem("lastViewedLetter");s&&!E&&!V&&(ee(!0),N(s))},[E,V]),h.useEffect(()=>{if(x.trim())ae(x);else{const s=O([...t],v);n(s)}},[x,v,t]);const U=async()=>{try{const s=await fetch(`${C}/api/emails`);if(!s.ok)throw new Error("Failed to fetch emails");const l=await s.json();o(l),n(O(l,v)),S(!1)}catch(s){if(!F)try{const l=await D.getAllEmails();if(l.length>0){o(l),n(O(l,v)),S(!1);return}}catch(l){console.error("Failed to load cached emails:",l)}g(s instanceof Error?s.message:"An error occurred"),S(!1)}},ae=async s=>{if(!s.trim()){n(O([...t],v)),I(!1);return}try{I(!0);const l=await fetch(`${C}/api/emails/search?q=${encodeURIComponent(s)}`);if(!l.ok)throw new Error("Failed to search emails");const d=await l.json();n(O(d,v)),I(!1)}catch(l){g(l instanceof Error?l.message:"An error occurred"),I(!1)}},O=(s,l)=>{const d=[...s];switch(l){case"date-desc":return d.sort((u,m)=>new Date(m.publish_date).getTime()-new Date(u.publish_date).getTime());case"date-asc":return d.sort((u,m)=>new Date(u.publish_date).getTime()-new Date(m.publish_date).getTime());case"subject-asc":return d.sort((u,m)=>u.subject.localeCompare(m.subject));case"subject-desc":return d.sort((u,m)=>m.subject.localeCompare(u.subject));default:return d}},ne=async()=>{try{const s=await fetch(`${C}/api/emails/random`);if(!s.ok)throw new Error("Failed to fetch random email");const l=await s.json();N(l.id)}catch(s){g(s instanceof Error?s.message:"An error occurred")}},re=async s=>{try{S(!0);const[l,d]=await Promise.all([fetch(`${C}/api/emails/${s}`),fetch(`${C}/api/emails/${s}/navigation`)]);if(!l.ok)throw new Error("Failed to fetch email");if(!d.ok)throw new Error("Failed to fetch navigation");const u=await l.json(),m=await d.json();i(u),j(m),T("reader"),S(!1),localStorage.setItem("lastViewedLetter",s)}catch(l){if(!F)try{const d=await D.getEmail(s);if(d){i(d);const u=await D.getAllEmails(),m=O(u,"date-desc"),M=m.findIndex(me=>me.id===s);j({prev:M>0?m[M-1]:null,next:M<m.length-1?m[M+1]:null}),T("reader"),S(!1);return}}catch(d){console.error("Failed to load cached email:",d)}g(l instanceof Error?l.message:"An error occurred"),S(!1)}},N=s=>{re(s),window.scrollTo(0,0)},oe=()=>{T("list"),i(null),j(null)},K=s=>new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),ie=s=>{const l=s.split(/<<MATCH>>|<<?\/MATCH>>/),d=[];for(let u=0;u<l.length;u++)u%2===0?d.push(l[u]):d.push(e.jsx("strong",{className:"search-highlight",children:l[u]},u));return e.jsx(e.Fragment,{children:d})},Q=50,ce=s=>{q(null),P(s.targetTouches[0].clientX)},le=s=>{q(s.targetTouches[0].clientX)},de=()=>{if(!_||!z)return;const s=_-z,l=s>Q,d=s<-Q;l&&(c!=null&&c.next)?N(c.next.id):d&&(c!=null&&c.prev)&&N(c.prev.id)},R=async()=>{try{const s=await D.getStats();se(s)}catch(s){console.error("Failed to get offline stats:",s)}},he=async()=>{try{k({current:0,total:100,message:"Starting download..."}),await D.downloadAllContent((s,l,d)=>{k({current:s,total:l,message:d})}),await R(),setTimeout(()=>k(null),2e3)}catch{g("Failed to download content for offline use"),k(null)}},ue=async()=>{if(confirm("Are you sure you want to clear all offline data?"))try{await D.clearAll(),await R(),alert("Offline data cleared successfully")}catch{g("Failed to clear offline data")}};return E&&!r?e.jsx("div",{className:"container",children:e.jsx("div",{className:"loading",children:"Loading..."})}):L?e.jsx("div",{className:"container",children:e.jsxs("div",{className:"error",children:["Error: ",L]})}):e.jsxs("div",{className:"container",children:[!F&&e.jsxs("div",{className:"offline-banner",children:["ðŸ“¡ You're offline -"," ",b&&b.emailCount>0?`${b.emailCount} letters available`:"No offline content available"]}),A&&e.jsxs("div",{className:"download-progress",children:[e.jsx("div",{className:"download-progress-bar",children:e.jsx("div",{className:"download-progress-fill",style:{width:`${A.current}%`}})}),e.jsxs("p",{children:[A.message," (",A.current,"%)"]})]}),Y==="list"?e.jsxs("div",{className:"email-list",children:[e.jsxs("header",{className:"header",children:[e.jsx("h1",{children:"thank you notes"}),e.jsx("p",{className:"subtitle",children:x?`${a.length} result${a.length!==1?"s":""}`:`${a.length} published issue${a.length!==1?"s":""}`})]}),e.jsxs("div",{className:"controls",children:[e.jsxs("div",{className:"search-container",children:[e.jsx("input",{type:"text",className:"search-input",placeholder:"Search newsletters...",value:x,onChange:s=>B(s.target.value)}),x&&e.jsx("button",{className:"clear-search",onClick:()=>B(""),title:"Clear search",children:"âœ•"})]}),e.jsxs("div",{className:"control-row",children:[e.jsxs("div",{className:"sort-container",children:[e.jsx("label",{htmlFor:"sort-select",children:"Sort by:"}),e.jsxs("select",{id:"sort-select",className:"sort-select",value:v,onChange:s=>Z(s.target.value),children:[e.jsx("option",{value:"date-desc",children:"Newest First"}),e.jsx("option",{value:"date-asc",children:"Oldest First"}),e.jsx("option",{value:"subject-asc",children:"Subject (A-Z)"}),e.jsx("option",{value:"subject-desc",children:"Subject (Z-A)"})]})]}),x&&e.jsxs("div",{className:"result-count",children:[a.length," result",a.length!==1?"s":""]}),e.jsx("button",{className:"btn btn-random",onClick:ne,title:"Go to random letter",children:"ðŸŽ² Random Letter"}),e.jsx("button",{className:"btn btn-offline",onClick:()=>te(!H),title:"Offline settings",children:"ðŸ“¥ Offline"})]})]}),H&&e.jsxs("div",{className:"offline-panel",children:[e.jsx("h3",{children:"Offline Mode"}),b?e.jsxs("div",{className:"offline-stats",children:[e.jsxs("p",{children:["ðŸ“§ ",b.emailCount," letters saved"]}),e.jsxs("p",{children:["ðŸ–¼ï¸ ",b.imageCount," images cached"]}),e.jsxs("p",{children:["ðŸ’¾ ",ye(b.totalSize)," total"]}),b.lastSync&&e.jsxs("p",{children:["ðŸ”„ Last sync:"," ",new Date(b.lastSync).toLocaleString()]})]}):e.jsx("p",{children:"No offline data available"}),e.jsxs("div",{className:"offline-actions",children:[e.jsx("button",{className:"btn btn-primary",onClick:he,disabled:!!A,children:A?"Downloading...":"â¬‡ï¸ Download All Content"}),b&&b.emailCount>0&&e.jsx("button",{className:"btn btn-danger",onClick:ue,children:"ðŸ—‘ï¸ Clear Offline Data"})]}),e.jsx("p",{className:"offline-note",children:"Download all letters and images for offline reading. This app works as a Progressive Web App (PWA) - you can install it on your device for a native app experience."})]}),J?e.jsx("div",{className:"searching",children:"Searching..."}):a.length===0?e.jsx("div",{className:"no-results",children:x?"No newsletters found matching your search.":"No newsletters available."}):e.jsx("div",{className:"list",children:a.map(s=>e.jsx("article",{className:"email-card",onClick:()=>N(s.id),children:e.jsxs("div",{className:"email-card-content",children:[e.jsx("h2",{children:s.subject}),s.searchSnippet?e.jsx("p",{className:"email-search-snippet",children:ie(s.searchSnippet)}):s.description&&e.jsx("p",{className:"email-description",children:s.description}),e.jsx("time",{className:"email-date",children:K(s.publish_date)})]})},s.id))})]}):e.jsxs("div",{className:"email-reader",onTouchStart:ce,onTouchMove:le,onTouchEnd:de,children:[r&&e.jsxs("article",{className:"email-content",children:[e.jsxs("header",{className:"email-header",children:[e.jsx("h1",{children:r.subject}),e.jsx("time",{className:"email-date",children:K(r.publish_date)})]}),e.jsx("div",{className:"email-body",children:e.jsx(be,{children:r.body||""})})]}),e.jsxs("nav",{className:"reader-nav reader-nav-bottom",children:[e.jsx("button",{onClick:oe,className:"btn-back-arrow",title:"Back to List",children:"home"}),e.jsxs("div",{className:"nav-buttons",children:[(c==null?void 0:c.prev)&&e.jsxs("button",{onClick:()=>N(c.prev.id),className:"btn btn-nav",children:["â† ",c.prev.subject]}),(c==null?void 0:c.next)&&e.jsxs("button",{onClick:()=>N(c.next.id),className:"btn btn-nav",children:[c.next.subject," â†’"]})]})]})]})]})}$.createRoot(document.getElementById("root")).render(e.jsx(je.StrictMode,{children:e.jsx(Ee,{})}));
